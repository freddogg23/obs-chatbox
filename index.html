<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OBS Chatbox Diagnostic</title>
<style>
  html,body{margin:0;height:100%;background:transparent;overflow:hidden;font-family:system-ui,Segoe UI,Arial}
  #pill{position:absolute;left:10px;top:10px;padding:10px 12px;border-radius:999px;
    background:rgba(0,0,0,.55);color:#fff;font-size:12px;max-width:calc(100% - 20px);
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
</style>
</head>
<body>
  <div id="pill">starting…</div>
<script>
  const pill = document.getElementById("pill");
  const channel = new URLSearchParams(location.search).get("channel") || "freddogg23";
  const url = "wss://irc-ws.chat.twitch.tv:443";

  function set(t){ pill.textContent = t; console.log(t); }

  let ws;
  function start(){
    try{ ws?.close(); }catch(e){}
    set(`connecting… ${url} (#${channel})`);
    ws = new WebSocket(url);

    ws.onopen = () => {
      set(`open ✅ joining #${channel}`);
      ws.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");
      ws.send("PASS SCHMOOPIIE");
      ws.send("NICK justinfan12345");
      ws.send(`JOIN #${channel}`);
    };

    ws.onmessage = (ev) => {
      const raw = ev.data || "";
      if (raw.startsWith("PING")) ws.send("PONG :tmi.twitch.tv");
      if (raw.includes(" JOIN #")) set(`online ✅ joined #${channel}`);
    };

    ws.onerror = (e) => {
      // Browser doesn't give much detail here, but keep it visible
      set(`error ❌ websocket error event`);
    };

    ws.onclose = (e) => {
      set(`closed ❌ code=${e.code} reason="${e.reason || ""}" wasClean=${e.wasClean}`);
      // 1006 is the big one: blocked/aborted
      setTimeout(start, 2500);
    };
  }
  start();
</script>
</body>
</html>
