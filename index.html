<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OBS Twitch Chatbox (7TV Emotes + 7TV Paints + Twitch Badges)</title>

<style>
  :root{
    --font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    --font-size: 24px;
    --line-height: 1.25;
    --gap: 10px;

    --msg-bg: rgba(0,0,0,0.35);
    --radius: 14px;
    --padY: 10px;
    --padX: 14px;

    --shadow: 0 6px 22px rgba(0,0,0,0.35);
    --text-shadow: 0 2px 8px rgba(0,0,0,0.6);

    --emote-size: 34px;
    --fade-ms: 220;
  }

  html,body{
    margin:0;
    height:100%;
    background:transparent;
    overflow:hidden;
    font-family:var(--font-family);
  }

  #wrap{
    position:absolute;
    inset:0;
    display:flex;
    align-items:flex-end;
    justify-content:flex-start;
    padding:12px;
    box-sizing:border-box;
  }

  #chat{
    width:100%;
    display:flex;
    flex-direction:column;
    gap:var(--gap);
    pointer-events:none;
  }

  .msg{
    display:flex;
    gap:10px;
    background:var(--msg-bg);
    border-radius:var(--radius);
    padding:calc(var(--padY)*1px) calc(var(--padX)*1px);
    box-shadow:var(--shadow);
    backdrop-filter:blur(6px);
    -webkit-backdrop-filter:blur(6px);
    opacity:0;
    transform:translateY(10px);
    transition:opacity var(--fade-ms)ms ease,transform var(--fade-ms)ms ease;
  }

  .msg.show{
    opacity:1;
    transform:translateY(0);
  }

  .left{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width:0;
    width:100%;
  }

  .topline{
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
    min-width:0;
  }

  .badges{
    display:flex;
    gap:4px;
    align-items:center;
  }

  img.badgeImg{
    width:18px;
    height:18px;
    border-radius:4px;
    vertical-align:-4px;
    filter:drop-shadow(0 1px 4px rgba(0,0,0,.35));
  }

  .badgeText{
    font-size:12px;
    line-height:1;
    padding:2px 6px;
    border-radius:999px;
    background:rgba(255,255,255,.14);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);
  }

  .name{
    font-size:var(--font-size);
    line-height:var(--line-height);
    font-weight:800;
    text-shadow:var(--text-shadow);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:55%;
  }

  /* Needed for paints */
  .paintText{
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent !important;
  }

  .text{
    font-size:var(--font-size);
    line-height:var(--line-height);
    font-weight:600;
    text-shadow:var(--text-shadow);
    word-break:break-word;
    overflow-wrap:anywhere;
    min-width:0;
  }

  img.emote{
    width:var(--emote-size);
    height:var(--emote-size);
    vertical-align:-8px;
    margin:0 2px;
  }

  #pill{
    position:absolute;
    left:10px;
    top:10px;
    z-index:40;
    font-size:12px;
    padding:8px 10px;
    border-radius:999px;
    background:rgba(0,0,0,.45);
    color:rgba(255,255,255,.95);
    box-shadow:0 10px 28px rgba(0,0,0,.35);
    backdrop-filter:blur(10px);
    -webkit-backdrop-filter:blur(10px);
    white-space:nowrap;
    pointer-events:none;
  }

  #menuToggle{
    position:absolute;
    top:10px;
    right:10px;
    z-index:50;
    width:44px;
    height:44px;
    border-radius:14px;
    border:0;
    background:rgba(0,0,0,.45);
    color:#fff;
    cursor:pointer;
    box-shadow:0 10px 28px rgba(0,0,0,.45);
  }

  #menu{
    position:absolute;
    top:64px;
    right:10px;
    z-index:50;
    width:420px;
    max-height:calc(100% - 80px);
    overflow:auto;
    border-radius:18px;
    background:rgba(12,12,12,.80);
    color:rgba(255,255,255,.95);
    box-shadow:0 18px 50px rgba(0,0,0,.55);
    padding:14px;
    display:none;
  }

  #menu.open{ display:block; }

  label{ font-size:12px; opacity:.9; display:block; margin-bottom:6px; }
  input,select,textarea{
    width:100%;
    box-sizing:border-box;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:#fff;
    padding:10px;
  }

  textarea{
    min-height:70px;
    resize:vertical;
    font-family:monospace;
    font-size:12px;
  }

  .btnRow{ display:flex; gap:10px; margin-top:10px; }
  .btn{
    flex:1;
    border:0;
    border-radius:14px;
    padding:10px;
    font-weight:800;
    background:rgba(255,255,255,.12);
    color:#fff;
    cursor:pointer;
  }
</style>
</head>

<body>
<div id="wrap"><div id="chat"></div></div>
<div id="pill">starting…</div>

<button id="menuToggle">⚙️</button>

<div id="menu">
  <label>Channel</label>
  <input id="channel">

  <label>Enable 7TV</label>
  <select id="enable7tv"><option value="1">Yes</option><option value="0">No</option></select>

  <label>7TV set</label>
  <select id="sevenTvMode">
    <option value="both">Both</option>
    <option value="global">Global</option>
    <option value="channel">Channel</option>
  </select>

  <label>Enable 7TV paints</label>
  <select id="enablePaints"><option value="1">Yes</option><option value="0">No</option></select>

  <label>Twitch Client ID</label>
  <input id="twitchClientId">

  <label>Twitch App Access Token</label>
  <input id="twitchToken">

  <div class="btnRow">
    <button class="btn" id="saveCreds">Save creds</button>
    <button class="btn" id="apply">Apply</button>
  </div>
</div>

<script>
/* =========================
   CORE HELPERS
========================= */
const $ = id => document.getElementById(id);
const chat = $("chat");
const pill = $("pill");

function setPill(t){ pill.textContent=t; }

const CREDS_KEY="twitch_creds_session_v1";
function getCreds(){ try{return JSON.parse(sessionStorage.getItem(CREDS_KEY));}catch{return null;} }
function setCreds(id,token){ sessionStorage.setItem(CREDS_KEY,JSON.stringify({id,token})); }

/* =========================
   TWITCH ID LOOKUP (CACHE)
========================= */
const twitchIdCache=new Map();
async function getTwitchId(login){
  if(twitchIdCache.has(login)) return twitchIdCache.get(login);
  const c=getCreds(); if(!c) return null;
  const r=await fetch(`https://api.twitch.tv/helix/users?login=${login}`,{
    headers:{ "Client-ID":c.id,"Authorization":`Bearer ${c.token}` }
  });
  const j=await r.json();
  const id=j?.data?.[0]?.id||null;
  if(id) twitchIdCache.set(login,id);
  return id;
}

/* =========================
   7TV PAINTS (V2 COSMETICS)
========================= */
function intToHex(n){
  n>>>0;
  const a=(n>>>24)&255,r=(n>>>16)&255,g=(n>>>8)&255,b=n&255;
  const h=x=>x.toString(16).padStart(2,"0");
  return a===255?`#${h(r)}${h(g)}${h(b)}`:`#${h(r)}${h(g)}${h(b)}${h(a)}`;
}

async function getPaintCSS(twitchId){
  const r=await fetch(`https://api.7tv.app/v2/cosmetics?user_identifier=twitch_id&id=${twitchId}`);
  const j=await r.json();
  const paint=j?.paints?.find(p=>p.users?.includes(String(twitchId)));
  if(!paint) return null;
  if(paint.stops?.length){
    const parts=paint.stops.map(s=>`${intToHex(s.color)} ${Math.round(s.at*100)}%`);
    return `background-image:linear-gradient(${paint.angle||90}deg,${parts.join(",")});`;
  }
  return paint.color?`color:${intToHex(paint.color)};`:null;
}

/* =========================
   CHAT MESSAGE
========================= */
async function addMessage(user,text){
  const nameDiv=document.createElement("div");
  nameDiv.className="name";
  nameDiv.textContent=user;

  if($("enablePaints").value==="1"){
    const id=await getTwitchId(user);
    if(id){
      const css=await getPaintCSS(id);
      if(css){
        nameDiv.classList.add("paintText");
        nameDiv.style.cssText=css;
      }
    }
  }

  const msg=document.createElement("div");
  msg.className="msg";
  msg.innerHTML=`<div class="left"><div class="topline"></div><div class="text">${text}</div></div>`;
  msg.querySelector(".topline").appendChild(nameDiv);

  chat.appendChild(msg);
  requestAnimationFrame(()=>msg.classList.add("show"));
}

/* =========================
   DEMO MESSAGE
========================= */
$("apply").onclick=()=>{
  setPill("online");
  addMessage("freddogg23","If you have a 7TV paint, your name should be painted now.");
};

$("saveCreds").onclick=()=>{
  setCreds($("twitchClientId").value,$("twitchToken").value);
  setPill("creds saved");
};

$("menuToggle").onclick=()=>$("menu").classList.toggle("open");
</script>
</body>
</html>
